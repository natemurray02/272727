<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AllIn27 | Texas Hold'em Poker</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ô†Ô∏è</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,sans-serif;background:radial-gradient(ellipse at 50% 30%,#0c1a14,#09090b 50%),linear-gradient(180deg,#09090b,#000);min-height:100vh;color:#fff;overflow-x:hidden}
    .lobby{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:1rem;padding-top:2rem}
    .logo{font-size:3rem;font-weight:bold;background:linear-gradient(135deg,#fef3c7,#fbbf24,#d97706);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.15em;margin-bottom:.25rem}
    .subtitle{color:#fbbf24;font-size:.8rem;margin-bottom:1.5rem;letter-spacing:.4em;opacity:.8}
    .lobby-container{width:100%;max-width:900px;display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
    @media(max-width:700px){.lobby-container{grid-template-columns:1fr}}
    .card-panel{padding:1.5rem;border-radius:1rem;background:linear-gradient(145deg,rgba(39,39,42,.5),rgba(9,9,11,.8));border:1px solid rgba(251,191,36,.15);box-shadow:0 10px 40px rgba(0,0,0,.4)}
    .panel-title{font-size:1.1rem;color:#fbbf24;margin-bottom:1rem;font-weight:600;display:flex;align-items:center;gap:.5rem}
    .tabs{display:flex;margin-bottom:1rem;gap:.5rem}
    .tab{flex:1;padding:.6rem;border:none;background:rgba(0,0,0,.3);color:#a1a1aa;font-size:.85rem;font-weight:600;cursor:pointer;border-radius:.5rem;transition:all .2s}
    .tab.active{background:linear-gradient(135deg,#fbbf24,#d97706);color:#451a03}
    input,select{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(251,191,36,.2);border-radius:.5rem;padding:.7rem;color:#fff;margin-bottom:.75rem;font-size:.9rem}
    input:focus,select:focus{outline:none;border-color:#fbbf24}
    label{display:block;color:#a1a1aa;font-size:.75rem;margin-bottom:.3rem;font-weight:500}
    .btn{width:100%;padding:.85rem;border-radius:.5rem;border:none;font-weight:bold;font-size:1rem;cursor:pointer;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#451a03;box-shadow:0 4px 15px rgba(251,191,36,.3)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(251,191,36,.4)}
    .btn-secondary{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
    .footer{margin-top:1.5rem;color:#52525b;font-size:.7rem;letter-spacing:.2em}
    .tables-list{max-height:350px;overflow-y:auto}
    .table-row{display:flex;justify-content:space-between;align-items:center;padding:.75rem;background:rgba(0,0,0,.3);border-radius:.5rem;margin-bottom:.5rem;border:1px solid rgba(255,255,255,.05)}
    .table-row:hover{border-color:rgba(251,191,36,.3)}
    .table-row.private{border-color:rgba(139,92,246,.3);background:rgba(139,92,246,.05)}
    .table-info{flex:1}
    .table-name{font-weight:600;color:#fff;font-size:.9rem;display:flex;align-items:center;gap:.4rem}
    .private-badge{color:#a78bfa;font-size:.7rem}
    .table-details{font-size:.7rem;color:#a1a1aa;margin-top:.2rem}
    .table-seats{display:flex;align-items:center;gap:.3rem;margin-right:1rem}
    .seat-dot{width:8px;height:8px;border-radius:50%;background:#3f3f46}
    .seat-dot.filled{background:#22c55e}
    .join-btn{padding:.4rem 1rem;border-radius:.4rem;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:.8rem;font-weight:600;cursor:pointer}
    .join-btn:disabled{background:#3f3f46;cursor:not-allowed}
    .join-btn.private-join{background:linear-gradient(135deg,#8b5cf6,#7c3aed)}
    .no-tables{text-align:center;color:#71717a;padding:2rem;font-size:.9rem}
    .refresh-btn{background:none;border:none;color:#fbbf24;cursor:pointer;font-size:1.2rem}
    .toggle-container{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;padding:.75rem;background:rgba(0,0,0,.3);border-radius:.5rem}
    .toggle-label{color:#a1a1aa;font-size:.85rem;flex:1}
    .toggle-label.active{color:#fff}
    .toggle-switch{position:relative;width:50px;height:26px;background:#3f3f46;border-radius:13px;cursor:pointer;transition:background .3s}
    .toggle-switch.on{background:linear-gradient(135deg,#8b5cf6,#7c3aed)}
    .toggle-knob{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:left .3s}
    .toggle-switch.on .toggle-knob{left:27px}
    .private-info{font-size:.7rem;color:#a78bfa;margin-top:.25rem}
    .game-container{min-height:100vh;position:relative;overflow:hidden}
    .header{display:flex;justify-content:space-between;align-items:center;padding:.5rem 1rem;margin:.25rem .5rem;border-radius:.75rem;background:linear-gradient(180deg,rgba(24,24,27,.9),rgba(9,9,11,.95));border:1px solid rgba(251,191,36,.15)}
    .header-logo{color:#fbbf24;font-weight:bold;font-size:1rem}
    .header-info{font-size:.75rem;color:#a1a1aa}
    .header-info span{color:#fbbf24}
    .header-info .private-indicator{color:#a78bfa}
    .leave-btn{padding:.4rem .8rem;border-radius:.4rem;border:none;background:#dc2626;color:#fff;font-size:.75rem;cursor:pointer}
    .leave-seat-btn{padding:.4rem .8rem;border-radius:.4rem;border:1px solid #fbbf24;background:transparent;color:#fbbf24;font-size:.75rem;cursor:pointer;margin-right:.5rem}
    .leave-seat-btn:hover{background:rgba(251,191,36,.1)}
    .lobby-btn{padding:.4rem .8rem;border-radius:.4rem;border:1px solid #a1a1aa;background:transparent;color:#a1a1aa;font-size:.75rem;cursor:pointer;margin-right:.5rem}
    .lobby-btn:hover{background:rgba(255,255,255,.1)}
    .header-buttons{display:flex;align-items:center}
    .share-link-box{display:flex;gap:.5rem;margin-top:.5rem}
    .share-link-input{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(139,92,246,.3);border-radius:.4rem;padding:.4rem .6rem;color:#a78bfa;font-size:.7rem;font-family:monospace}
    .copy-btn{padding:.4rem .8rem;border-radius:.4rem;border:none;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;font-size:.7rem;cursor:pointer;font-weight:600}
    .table-area{position:relative;width:100%;height:calc(100vh - 200px);min-height:400px}
    .felt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:75%;height:65%;border-radius:50%;background:radial-gradient(ellipse,#065f46,#064e3b 40%,#022c22);border:10px solid #18181b;box-shadow:inset 0 0 80px rgba(0,0,0,.6),0 0 0 4px #09090b,0 0 0 14px #18181b}
    .felt-brand{position:absolute;bottom:15%;left:50%;transform:translateX(-50%);color:#fbbf24;opacity:.15;font-size:1.5rem;font-weight:bold;letter-spacing:.2em}
    .pot-area{position:absolute;top:30%;left:50%;transform:translateX(-50%);display:flex;align-items:flex-end;gap:.5rem;z-index:10}
    .chip-stack{display:flex;flex-direction:column-reverse}
    .chip{width:20px;height:6px;border-radius:50%;margin-top:-3px}
    .chip-red{background:linear-gradient(180deg,#ef4444,#991b1b);border:1px solid #fca5a5}
    .chip-gold{background:linear-gradient(180deg,#fbbf24,#b45309);border:1px solid #fcd34d}
    .chip-black{background:linear-gradient(180deg,#374151,#111827);border:1px solid #6b7280}
    .pot-amount{padding:.25rem .75rem;background:rgba(0,0,0,.8);border-radius:10px;font-family:monospace;font-weight:bold;font-size:1rem;color:#fbbf24}
    .community-cards{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:6px;z-index:10}
    .card{width:40px;height:56px;background:linear-gradient(145deg,#fafafa,#e4e4e7);border-radius:5px;border:2px solid #e4e4e7;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:monospace;font-weight:700;font-size:.9rem;box-shadow:0 3px 10px rgba(0,0,0,.4)}
    .card.small{width:30px;height:42px;font-size:.7rem}
    .card.my-card{cursor:pointer;transition:all .2s}
    .card.my-card:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(251,191,36,.4)}
    .card.my-card.revealed{box-shadow:0 0 10px rgba(251,191,36,.8);border-color:#fbbf24}
    .card.red{color:#dc2626}
    .card.black{color:#18181b}
    .card.hidden{background:linear-gradient(145deg,#dc2626,#991b1b);border:2px solid #fefefe;position:relative;display:flex;align-items:center;justify-content:center}
    .card.hidden::before{content:'';position:absolute;inset:3px;border:1px solid rgba(255,255,255,.3);border-radius:3px;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.1) 2px,rgba(255,255,255,.1) 4px)}
    .card.hidden::after{content:'‚ô¶';color:rgba(255,255,255,.5);font-size:.8rem;position:absolute}
    .card.empty{background:transparent;border:2px dashed rgba(255,215,0,.2)}
    .seat{position:absolute;width:85px;transform:translate(-50%,-50%);z-index:20}
    .player-box{border-radius:10px;padding:.4rem;background:linear-gradient(145deg,rgba(39,39,42,.95),rgba(24,24,27,.98));border:2px solid rgba(63,63,70,.5);text-align:center}
    .player-box.active{border-color:#f59e0b;box-shadow:0 0 20px rgba(245,158,11,.4)}
    .player-box.me{border-color:rgba(34,197,94,.5)}
    .player-box.folded{opacity:.3}
    .player-box.sitting-out{opacity:.5}
    .player-cards{display:flex;justify-content:center;gap:3px;margin-bottom:.25rem}
    .player-name{font-size:.6rem;color:#e4e4e7;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .player-chips{font-size:.65rem;font-family:monospace;color:#fbbf24;font-weight:700}
    .player-bet{position:absolute;top:-25px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(0,0,0,.85);border:1px solid rgba(255,215,0,.3);border-radius:8px;font-size:.65rem;font-family:monospace;color:#ffe55c;white-space:nowrap}
    .bet-chips{display:flex;gap:1px}
    .bet-chip{width:10px;height:10px;border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.5)}
    .bet-chip.chip-red{background:linear-gradient(180deg,#ef4444,#991b1b);border:1px solid #fca5a5}
    .bet-chip.chip-gold{background:linear-gradient(180deg,#fbbf24,#b45309);border:1px solid #fcd34d}
    .badge{position:absolute;font-size:.35rem;padding:2px 4px;border-radius:3px;font-weight:600;color:#fff}
    .badge-dealer{top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,#fef3c7,#fbbf24);color:#78350f;display:flex;align-items:center;justify-content:center;font-size:.45rem}
    .badge-sb{bottom:-6px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#22c55e,#16a34a)}
    .badge-bb{bottom:-6px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#f59e0b,#d97706)}
    .badge-allin{top:-4px;right:-4px;background:linear-gradient(135deg,#ef4444,#dc2626);font-size:.3rem}
    .empty-seat{border:2px dashed rgba(251,191,36,.2);background:rgba(0,0,0,.2);padding:1rem .5rem;border-radius:10px;color:#52525b;font-size:.65rem}
    .empty-seat.clickable-seat{cursor:pointer;transition:all .2s}
    .empty-seat.clickable-seat:hover{border-color:rgba(251,191,36,.5);background:rgba(251,191,36,.1);color:#fbbf24}
    .deck{position:absolute;top:50%;left:80%;transform:translate(-50%,-50%);z-index:5}
    .deck-card{position:absolute;width:34px;height:48px;background:linear-gradient(145deg,#dc2626,#991b1b);border:2px solid #fefefe;border-radius:4px;display:flex;align-items:center;justify-content:center}
    .deck-card-inner{width:26px;height:40px;border:1px solid rgba(255,255,255,.3);border-radius:2px;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.1) 2px,rgba(255,255,255,.1) 4px);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.4);font-size:.7rem}
    .actions{position:fixed;bottom:0;left:0;right:0;padding:.75rem 1rem 1.5rem;background:linear-gradient(180deg,transparent,rgba(9,9,11,.98) 30%);z-index:50}
    .action-buttons{display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem}
    .action-btn{padding:.7rem 1.2rem;border-radius:10px;font-weight:600;cursor:pointer;font-size:.9rem}
    .btn-fold{background:linear-gradient(180deg,#27272a,#18181b);border:1px solid #3f3f46;color:#a1a1aa}
    .btn-check,.btn-call{background:linear-gradient(180deg,#065f46,#064e3b);border:1px solid #065f46;color:#6ee7b7}
    .btn-raise{background:linear-gradient(180deg,#d97706,#b45309);border:1px solid #b45309;color:#fef3c7}
    .btn-allin{background:linear-gradient(180deg,#dc2626,#991b1b);border:1px solid #991b1b;color:#fecaca;font-weight:700}
    .raise-controls{display:flex;justify-content:center;align-items:center;gap:.5rem;flex-wrap:wrap}
    .raise-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(180deg,#27272a,#18181b);border:1px solid #3f3f46;color:#fbbf24;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .raise-slider{width:140px;accent-color:#d97706}
    .raise-amount{color:#fbbf24;font-family:monospace;font-size:1.1rem;font-weight:700;min-width:70px;text-align:center}
    .preset-btn{padding:.4rem .7rem;border-radius:6px;background:linear-gradient(180deg,#27272a,#18181b);border:1px solid #3f3f46;color:#fbbf24;font-size:.75rem;cursor:pointer;font-weight:600}
    .waiting-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
    .room-code{font-size:2.5rem;font-weight:bold;color:#fbbf24;letter-spacing:.3em;margin-bottom:.75rem}
    .waiting-text{color:#a1a1aa;font-size:.9rem;margin-bottom:1.5rem}
    .player-list{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center;margin-bottom:1.5rem}
    .player-chip{padding:.4rem .8rem;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:16px;color:#fbbf24;font-size:.8rem}
    .start-btn{padding:.9rem 2.5rem;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:10px;color:#fff;font-size:1.1rem;font-weight:bold;cursor:pointer;letter-spacing:.1em}
    .start-btn:disabled{background:#3f3f46;cursor:not-allowed}
    .chat-box{position:fixed;bottom:100px;left:.5rem;width:220px;height:180px;background:linear-gradient(180deg,rgba(9,9,11,.95),rgba(9,9,11,.98));border-radius:10px;border:1px solid rgba(251,191,36,.2);z-index:45;display:flex;flex-direction:column}
    .chat-header{padding:.4rem .6rem;border-bottom:1px solid rgba(251,191,36,.15);font-size:.7rem;color:#fbbf24;font-weight:600}
    .chat-messages{flex:1;overflow-y:auto;padding:.4rem;font-size:.65rem}
    .chat-msg{margin-bottom:.25rem;color:#d4d4d8;line-height:1.3}
    .chat-msg .name{color:#fbbf24;font-weight:600}
    .chat-input-container{padding:.4rem;border-top:1px solid rgba(251,191,36,.15)}
    .chat-input-container input{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(251,191,36,.2);border-radius:6px;padding:.4rem .6rem;color:#fff;font-size:.7rem;margin:0}
    .chat-input-container input:focus{outline:none;border-color:#fbbf24}
    .action-log{position:fixed;bottom:100px;right:.5rem;width:220px;height:220px;background:linear-gradient(180deg,rgba(9,9,11,.95),rgba(9,9,11,.98));border-radius:10px;border:1px solid rgba(251,191,36,.2);z-index:45;display:flex;flex-direction:column}
    .log-header{padding:.4rem .6rem;border-bottom:1px solid rgba(251,191,36,.15);font-size:.7rem;color:#f59e0b;font-weight:600}
    .log-messages{flex:1;overflow-y:auto;padding:.4rem;font-size:.65rem}
    .log-msg{margin-bottom:.25rem;line-height:1.3}
    .log-msg.fold{color:#71717a}.log-msg.check{color:#60a5fa}.log-msg.call{color:#4ade80}.log-msg.raise,.log-msg.allin{color:#f87171}.log-msg.win{color:#fbbf24}.log-msg.system{color:#a1a1aa}.log-msg.cards{color:#c084fc}.log-msg.board{color:#22d3ee}
    .winner-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;background:rgba(0,0,0,.7);animation:fadeIn .3s}
    .winner-box{text-align:center;padding:1.5rem 2.5rem;background:linear-gradient(145deg,#18181b,#09090b);border:2px solid #fbbf24;border-radius:1rem;box-shadow:0 0 60px rgba(251,191,36,.3)}
    .winner-title{font-size:1.75rem;color:#fbbf24;font-weight:bold;margin-bottom:.4rem}
    .winner-hand{color:#a1a1aa;font-size:.9rem;margin-bottom:.4rem}
    .winner-amount{font-size:1.3rem;color:#22c55e;font-family:monospace;font-weight:bold}
    .sit-in-btn{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);padding:.8rem 2rem;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:10px;color:#fff;font-size:1rem;font-weight:bold;cursor:pointer;z-index:60}
    .btn-show-cards{background:#1a1a1a;border:2px solid #d4af37;color:#d4af37;font-weight:bold}
    .btn-show-cards:hover{background:#d4af37;color:#1a1a1a}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .hidden{display:none!important}
    .auth-header{position:fixed;top:0;right:0;display:flex;align-items:center;padding:.75rem 1rem;z-index:200}
    .auth-header.in-game{display:none}
    .auth-btn{padding:.5rem 1rem;border-radius:.5rem;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s;margin-left:.5rem}
    .auth-btn-login{background:transparent;border:1px solid rgba(251,191,36,.5);color:#fbbf24}
    .auth-btn-login:hover{background:rgba(251,191,36,.1)}
    .auth-btn-signup{background:linear-gradient(135deg,#fbbf24,#d97706);border:none;color:#451a03}
    .auth-btn-signup:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(251,191,36,.3)}
    .user-menu{position:relative}
    .user-display{display:flex;align-items:center;gap:.5rem;padding:.4rem .8rem;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:2rem;cursor:pointer}
    .user-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#fbbf24,#d97706);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:.75rem;color:#451a03}
    .user-name{color:#fbbf24;font-size:.85rem;font-weight:600}
    .user-dropdown{position:absolute;top:100%;right:0;margin-top:.5rem;background:#18181b;border:1px solid rgba(251,191,36,.2);border-radius:.5rem;min-width:150px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all .2s}
    .user-dropdown.show{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-item{padding:.75rem 1rem;color:#e4e4e7;font-size:.85rem;cursor:pointer}
    .dropdown-item:hover{background:rgba(251,191,36,.1)}
    .dropdown-item.logout{color:#ef4444}
  </style>
</head>
<body>
  <div class="auth-header" id="authHeader"></div>

<div class="auth-modal-overlay" id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:300">
  <div class="auth-modal" style="background:linear-gradient(145deg,#27272a,#18181b);border:1px solid rgba(251,191,36,.3);border-radius:1rem;padding:2rem;width:100%;max-width:400px;margin:1rem;position:relative">
    <button onclick="hideAuthModal()" style="position:absolute;top:1rem;right:1rem;background:none;border:none;color:#71717a;font-size:1.5rem;cursor:pointer">&times;</button>
    <div style="text-align:center;margin-bottom:1.5rem">
      <h2 style="font-size:1.5rem;background:linear-gradient(135deg,#fef3c7,#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent">‚ô† ALL IN 27</h2>
    </div>
    <div class="auth-tabs" style="display:flex;margin-bottom:1.5rem;gap:.5rem">
      <button class="tab active" id="loginTab" onclick="showLoginForm()">Log In</button>
      <button class="tab" id="signupTab" onclick="showSignupForm()">Sign Up</button>
    </div>
    <div id="authError" class="hidden" style="background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.5);color:#fca5a5;padding:.75rem;border-radius:.5rem;margin-bottom:1rem;font-size:.85rem"></div>
    <div id="authSuccess" class="hidden" style="background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.5);color:#86efac;padding:.75rem;border-radius:.5rem;margin-bottom:1rem;font-size:.85rem"></div>
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div style="margin-bottom:1rem"><label>Email</label><input type="email" id="loginEmail" placeholder="your@email.com" required></div>
      <div style="margin-bottom:1rem"><label>Password</label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
      <button type="submit" class="btn btn-primary">Log In</button>
      <button type="button" onclick="showForgotForm()" style="background:none;border:none;color:#fbbf24;cursor:pointer;font-size:.85rem;margin-top:.75rem;width:100%">Forgot password?</button>
    </form>
    <form id="signupForm" class="hidden" onsubmit="handleSignup(event)">
      <div style="margin-bottom:1rem"><label>Email</label><input type="email" id="signupEmail" placeholder="your@email.com" required></div>
      <div style="margin-bottom:1rem"><label>Phone Number</label><input type="tel" id="signupPhone" placeholder="+1 234 567 8900"></div>
      <div style="margin-bottom:1rem"><label>Password</label><input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
      <div style="margin-bottom:1rem"><label>Confirm Password</label><input type="password" id="signupConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
      <button type="submit" class="btn btn-primary">Create Account</button>
    </form>
    <form id="forgotForm" class="hidden" onsubmit="handleForgot(event)">
      <div style="margin-bottom:1rem"><label>Email</label><input type="email" id="forgotEmail" placeholder="your@email.com" required></div>
      <button type="submit" class="btn btn-primary">Reset Password</button>
      <button type="button" onclick="showLoginForm()" style="background:none;border:none;color:#fbbf24;cursor:pointer;font-size:.85rem;margin-top:.75rem;width:100%">Back to login</button>
    </form>
  </div>
</div>
<div id="app"></div>
  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://sumidwwkwrocixmrsgiv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1bWlkd3drd3JvY2l4bXJzZ2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2ODQ1NzgsImV4cCI6MjA4NDI2MDU3OH0.2MdNumOLrErGknOE4SqLzs1ZIs6HOfp2JZpuz5UIhrs';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null;
    
    // CHAT: Track input value and focus state independently
    let chatInputValue = '';
    let chatInputFocused = false;
    
    function renderAuthHeader() {
      const header = document.getElementById('authHeader');
      if (currentUser) {
        const name = currentUser.email.split('@')[0];
        header.innerHTML = '<div class="user-menu"><div class="user-display" onclick="toggleUserDropdown()"><div class="user-avatar">'+name.charAt(0).toUpperCase()+'</div><span class="user-name">'+name+'</span></div><div class="user-dropdown" id="userDropdown"><div class="dropdown-item">üë§ Profile</div><div class="dropdown-item logout" onclick="handleLogout()">üö™ Log Out</div></div></div>';
      } else {
        header.innerHTML = '<button class="auth-btn auth-btn-login" onclick="showAuthModal(\'login\')">Log In</button><button class="auth-btn auth-btn-signup" onclick="showAuthModal(\'signup\')">Sign Up</button>';
      }
    }
    function toggleUserDropdown() { document.getElementById('userDropdown').classList.toggle('show'); }
    function showAuthModal(mode) { document.getElementById('authModal').style.display = 'flex'; if (mode === 'signup') showSignupForm(); else showLoginForm(); }
    function hideAuthModal() { document.getElementById('authModal').style.display = 'none'; }
    function showLoginForm() { document.getElementById('loginTab').classList.add('active'); document.getElementById('signupTab').classList.remove('active'); document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('signupForm').classList.add('hidden'); document.getElementById('forgotForm').classList.add('hidden'); document.getElementById('authError').classList.add('hidden'); document.getElementById('authSuccess').classList.add('hidden'); }
    function showSignupForm() { document.getElementById('signupTab').classList.add('active'); document.getElementById('loginTab').classList.remove('active'); document.getElementById('signupForm').classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); document.getElementById('forgotForm').classList.add('hidden'); document.getElementById('authError').classList.add('hidden'); document.getElementById('authSuccess').classList.add('hidden'); }
    function showForgotForm() { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('forgotForm').classList.remove('hidden'); }
    function showAuthError(msg) { const el = document.getElementById('authError'); el.textContent = msg; el.classList.remove('hidden'); }
    function showAuthSuccess(msg) { const el = document.getElementById('authSuccess'); el.textContent = msg; el.classList.remove('hidden'); }
    async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; const { data, error } = await sb.auth.signInWithPassword({ email, password }); if (error) showAuthError(error.message); else { currentUser = data.user; hideAuthModal(); renderAuthHeader(); } }
    async function handleSignup(e) { e.preventDefault(); const email = document.getElementById('signupEmail').value; const password = document.getElementById('signupPassword').value; const confirm = document.getElementById('signupConfirm').value; if (password !== confirm) { showAuthError('Passwords do not match'); return; } const { data, error } = await sb.auth.signUp({ email, password }); if (error) showAuthError(error.message); else showAuthSuccess('Account created! Check your email to confirm.'); }
    async function handleForgot(e) { e.preventDefault(); const email = document.getElementById('forgotEmail').value; const { error } = await sb.auth.resetPasswordForEmail(email); if (error) showAuthError(error.message); else showAuthSuccess('Password reset email sent!'); }
    async function handleLogout() { await sb.auth.signOut(); currentUser = null; renderAuthHeader(); }
    sb.auth.getSession().then(({ data }) => { if (data.session) currentUser = data.session.user; renderAuthHeader(); });
    
    const socket = io();
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
      try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        if (type === 'fold') { osc.frequency.value = 200; gain.gain.value = 0.15; osc.start(); osc.stop(audioCtx.currentTime + 0.15); }
        else if (type === 'check') { osc.frequency.value = 600; gain.gain.value = 0.1; osc.start(); osc.stop(audioCtx.currentTime + 0.08); }
        else if (type === 'call') { osc.frequency.value = 500; gain.gain.value = 0.15; osc.start(); osc.stop(audioCtx.currentTime + 0.12); }
        else if (type === 'raise') { osc.frequency.value = 700; gain.gain.value = 0.2; osc.type = 'square'; osc.start(); osc.stop(audioCtx.currentTime + 0.15); }
        else if (type === 'allin') { osc.frequency.value = 900; gain.gain.value = 0.25; osc.type = 'sawtooth'; osc.start(); osc.stop(audioCtx.currentTime + 0.3); }
        else if (type === 'deal') { osc.frequency.value = 1200; gain.gain.value = 0.08; osc.start(); osc.stop(audioCtx.currentTime + 0.05); }
        else if (type === 'win') { [523,659,784].forEach((f,i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.value = 0.15; o.start(audioCtx.currentTime + i * 0.15); o.stop(audioCtx.currentTime + i * 0.15 + 0.2); }); return; }
        else if (type === 'click') { osc.frequency.value = 800; gain.gain.value = 0.1; osc.start(); osc.stop(audioCtx.currentTime + 0.05); }
      } catch(e) {}
    }
    
    const SEAT_POSITIONS = {
      2: [[50,85],[50,15]], 3: [[50,85],[15,50],[85,50]], 4: [[50,85],[12,50],[50,15],[88,50]],
      5: [[50,85],[12,65],[20,20],[80,20],[88,65]], 6: [[50,85],[12,65],[15,25],[50,10],[85,25],[88,65]],
      7: [[50,85],[12,65],[12,35],[30,12],[70,12],[88,35],[88,65]], 8: [[50,85],[15,70],[10,42],[22,15],[50,8],[78,15],[90,42],[85,70]],
      9: [[50,85],[15,70],[10,45],[18,18],[50,8],[82,18],[90,45],[85,70],[50,95]]
    };
    const BLINDS = [[0.01,0.02],[0.02,0.04],[0.1,0.2],[0.2,0.4],[0.5,1],[1,2],[2,4],[5,10],[10,20],[25,50],[50,100],[100,200],[500,1000]];
    const SUIT_SYM = { h:'‚ô•', d:'‚ô¶', c:'‚ô£', s:'‚ô†' };
    
    // Check URL for table code (for direct links to private tables)
    const urlParams = new URLSearchParams(window.location.search);
    const urlTableCode = urlParams.get('table');
    
    let state = { 
      screen:'lobby', 
      tab:'create', 
      name:localStorage.getItem('pokerName')||'', 
      tableCode: urlTableCode || '', 
      maxSeats:6, 
      blindsIdx:5, 
      buyIn:200, 
      seatIdx:-1, 
      isHost:false, 
      gameState:null, 
      seats:[], 
      phase:'waiting', 
      showRaise:false, 
      raiseAmt:0, 
      chatMessages:[], 
      actionLog:[], 
      winner:null, 
      tables:[], 
      sittingOut:false,
      isPrivate: false,
      hasCodeFromUrl: !!urlTableCode,
      lastBoardLength: 0,
      isSpectator: false,
      revealedCards: [false, false]  // Track which of my cards are revealed
    };
    
    function fmt(n) { return n >= 1000 ? (n/1000).toFixed(n%1000?1:0)+'k' : n.toString(); }
    
    // Format card for action log (e.g., "A‚ô†" or "K‚ô•")
    function fmtCard(card) {
      if (!card || !card.suit || !card.rank) return '??';
      const rank = card.rank === 'T' ? '10' : card.rank;
      return rank + SUIT_SYM[card.suit];
    }
    
    // Format multiple cards (e.g., "A‚ô† K‚ô•")
    function fmtCards(cards) {
      if (!cards || cards.length === 0) return '';
      return cards.map(fmtCard).join(' ');
    }
    
    function renderCard(card, small=false, hidden=false) {
      if (!card || hidden || !card.suit) return '<div class="card '+(small?'small':'')+' hidden"></div>';
      const color = (card.suit==='h'||card.suit==='d') ? 'red' : 'black';
      const rank = card.rank==='T' ? '10' : card.rank;
      return '<div class="card '+(small?'small':'')+' '+color+'"><span>'+rank+'</span><span>'+SUIT_SYM[card.suit]+'</span></div>';
    }
    
    function getShareLink(code) {
      return window.location.origin + '?table=' + code;
    }
    
    function copyShareLink() {
      const link = getShareLink(state.tableCode);
      navigator.clipboard.writeText(link).then(() => {
        const btn = document.getElementById('copyLinkBtn');
        if (btn) {
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
        }
      });
    }
    
    function render() {
      const app = document.getElementById('app');
      const authHeader = document.getElementById('authHeader');
      
      // Hide auth header when in game
      if (authHeader) {
        if (state.screen === 'game' || state.screen === 'waiting') {
          authHeader.classList.add('in-game');
        } else {
          authHeader.classList.remove('in-game');
        }
      }
      
      if (state.screen === 'lobby') app.innerHTML = renderLobby();
      else if (state.screen === 'waiting') app.innerHTML = renderWaiting();
      else if (state.screen === 'game') app.innerHTML = renderGame();
      attachEvents();
      
      // CHAT: Restore input value after render
      const chatInput = document.getElementById('chatInput');
      if (chatInput && chatInput.value !== chatInputValue) {
        chatInput.value = chatInputValue;
      }
      
      // Scroll action log to bottom
      const logEl = document.getElementById('logMessages');
      if (logEl) logEl.scrollTop = logEl.scrollHeight;
    }
    
    function renderLobby() {
      const [sb,bb] = BLINDS[state.blindsIdx];
      
      // If user came via direct link, show join prompt
      if (state.hasCodeFromUrl && state.tableCode) {
        return '<div class="lobby"><h1 class="logo">‚ô† ALL IN 27</h1><p class="subtitle">TEXAS HOLDEM</p><div class="card-panel" style="max-width:400px"><div class="panel-title"><span>üîí</span> Join Private Table</div><p style="color:#a1a1aa;margin-bottom:1rem;font-size:.9rem">You\'ve been invited to table <span style="color:#a78bfa;font-weight:bold">'+state.tableCode+'</span></p><label>Your Name</label><input type="text" id="name" placeholder="Enter name..." value="'+state.name+'"><label>Buy-in: $'+fmt(state.buyIn)+'</label><input type="range" id="buyIn" min="100" max="10000" step="100" value="'+state.buyIn+'"><button class="btn btn-secondary" id="joinPrivateBtn" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">JOIN PRIVATE TABLE</button><button class="btn" id="backToLobbyBtn" style="margin-top:.5rem;background:transparent;border:1px solid #3f3f46;color:#a1a1aa">Back to Lobby</button></div></div>';
      }
      
      return '<div class="lobby"><h1 class="logo">‚ô† ALL IN 27</h1><p class="subtitle">TEXAS HOLDEM</p><div class="lobby-container"><div class="card-panel"><div class="panel-title"><span>üéÆ</span> Active Tables <button class="refresh-btn" id="refreshBtn">üîÑ</button></div><div class="tables-list">'+(state.tables.length===0?'<div class="no-tables">No active tables. Create one!</div>':state.tables.map(t=>'<div class="table-row '+(t.isPrivate?'private':'')+'"><div class="table-info"><div class="table-name">'+(t.isPrivate?'<span class="private-badge">üîí</span>':'')+t.hostName+'\'s Table</div><div class="table-details">'+t.blinds+' blinds ‚Ä¢ $'+fmt(t.buyIn)+' buy-in'+(t.inProgress?' ‚Ä¢ In Progress':'')+'</div></div><div class="table-seats">'+Array(t.maxSeats).fill(0).map((_,i)=>'<div class="seat-dot '+(i<t.playerCount?'filled':'')+'"></div>').join('')+'</div>'+(t.isPrivate?'<button class="join-btn private-join" disabled title="Need invite link">Private</button>':'<button class="join-btn" data-code="'+t.code+'" '+(t.playerCount>=t.maxSeats?'disabled':'')+'>'+(t.playerCount>=t.maxSeats?'Full':'Join')+'</button>')+'</div>').join(''))+'</div></div><div class="card-panel"><div class="tabs"><button class="tab '+(state.tab==='create'?'active':'')+'" data-tab="create">Create Table</button><button class="tab '+(state.tab==='join'?'active':'')+'" data-tab="join">Join by Code</button></div><label>Your Name</label><input type="text" id="name" placeholder="Enter name..." value="'+state.name+'">'+(state.tab==='create'?'<div class="toggle-container"><span class="toggle-label '+(state.isPrivate?'':'active')+'">üåê Public</span><div class="toggle-switch '+(state.isPrivate?'on':'')+'" id="privateToggle"><div class="toggle-knob"></div></div><span class="toggle-label '+(state.isPrivate?'active':'')+'">üîí Private</span></div>'+(state.isPrivate?'<div class="private-info">Private tables require an invite link to join</div>':'')+'<label>Table Size</label><select id="maxSeats">'+[2,3,4,5,6,7,8,9].map(n=>'<option value="'+n+'" '+(state.maxSeats===n?'selected':'')+'>'+n+' Seats</option>').join('')+'</select><label>Blinds</label><select id="blinds">'+BLINDS.map((b,i)=>'<option value="'+i+'" '+(state.blindsIdx===i?'selected':'')+'>$'+b[0]+' / $'+b[1]+'</option>').join('')+'</select><label>Buy-in: $'+fmt(state.buyIn)+'</label><input type="range" id="buyIn" min="'+(bb*20)+'" max="'+(bb*200)+'" step="'+(bb*10)+'" value="'+state.buyIn+'"><button class="btn btn-primary" id="createBtn" style="'+(state.isPrivate?'background:linear-gradient(135deg,#8b5cf6,#7c3aed)':'')+'">CREATE '+(state.isPrivate?'PRIVATE ':'')+'TABLE</button>':'<label>Table Code</label><input type="text" id="tableCode" placeholder="Enter 6-digit code..." value="'+state.tableCode+'" maxlength="6" style="text-transform:uppercase;letter-spacing:.2em;text-align:center;font-size:1.3rem"><label>Buy-in: $'+fmt(state.buyIn)+'</label><input type="range" id="buyIn" min="100" max="10000" step="100" value="'+state.buyIn+'"><button class="btn btn-secondary" id="joinBtn">JOIN TABLE</button>')+'</div></div><p class="footer">AllIn27.com</p></div>';
    }
    
    function renderWaiting() {
      const playerCount = state.seats.filter(s=>s).length;
      const isPrivateTable = state.gameState?.isPrivate;
      return '<div class="game-container">'+renderGameTable()+'<div class="waiting-overlay">'+(isPrivateTable?'<p style="color:#a78bfa;margin-bottom:.25rem;font-size:.75rem">üîí PRIVATE TABLE</p>':'')+'<p style="color:#a1a1aa;margin-bottom:.4rem;font-size:.85rem">'+(isPrivateTable?'Share this link with friends:':'Table Code:')+'</p>'+(isPrivateTable?'<div class="share-link-box" style="margin-bottom:.75rem;max-width:350px"><input class="share-link-input" id="shareLinkInput" value="'+getShareLink(state.tableCode)+'" readonly><button class="copy-btn" id="copyLinkBtn" onclick="copyShareLink()">Copy</button></div>':'<div class="room-code">'+state.tableCode+'</div>')+'<p class="waiting-text">Waiting for players... ('+playerCount+'/'+state.maxSeats+')</p><div class="player-list">'+state.seats.map((s,i)=>s?'<div class="player-chip">'+s.name+'</div>':'').join('')+'</div>'+(state.isHost?'<button class="start-btn" id="startBtn" '+(playerCount<2?'disabled':'')+'>'+(playerCount<2?'NEED 2+ PLAYERS':'START GAME')+'</button>':'<p style="color:#71717a;font-size:.85rem">Waiting for host to start...</p>')+'</div></div>';
    }
    
    function renderGameTable() {
      const gs = state.gameState;
      if (!gs) return '<div>Loading...</div>';
      const positions = SEAT_POSITIONS[gs.maxSeats] || SEAT_POSITIONS[6];
      const potChips = Math.min(10, Math.max(2, Math.ceil(gs.pot / gs.bb / 2)));
      const isPrivateTable = gs.isPrivate;
      let html = '<div class="header"><span class="header-logo">‚ô† AllIn27</span><span class="header-info">'+(isPrivateTable?'<span class="private-indicator">üîí Private</span> | ':'')+'Code: <span>'+state.tableCode+'</span> | Blinds: <span>$'+gs.sb+'/$'+gs.bb+'</span> | Hand <span>#'+(gs.handNum||0)+'</span></span><div class="header-buttons">'+(state.isSpectator?'<button class="lobby-btn" id="lobbyBtn">‚Üê Lobby</button>':'<button class="leave-seat-btn" id="leaveSeatBtn">Leave Seat</button>')+'<button class="leave-btn" id="leaveBtn">Leave Table</button></div></div><div class="table-area"><div class="felt"><div class="felt-brand">ALLIN27</div></div>';
      if (gs.pot > 0) html += '<div class="pot-area"><div style="display:flex;gap:3px"><div class="chip-stack">'+Array(Math.ceil(potChips/3)).fill('<div class="chip chip-red"></div>').join('')+'</div><div class="chip-stack">'+Array(Math.ceil(potChips/4)).fill('<div class="chip chip-black"></div>').join('')+'</div><div class="chip-stack">'+Array(Math.ceil(potChips/2)).fill('<div class="chip chip-gold"></div>').join('')+'</div></div><div class="pot-amount">$'+fmt(gs.pot)+'</div></div>';
      html += '<div class="community-cards">'+[0,1,2,3,4].map(i=>gs.community[i]?renderCard(gs.community[i]):'<div class="card empty"></div>').join('')+'</div>';
      html += '<div class="deck">'+[0,1,2,3,4,5].map(i=>'<div class="deck-card" style="top:'+(-i)+'px;left:'+(-i*0.5)+'px"><div class="deck-card-inner">‚ô¶</div></div>').join('')+'</div>';
      gs.players.forEach((p,i) => {
        const pos = positions[i];
        if (!pos) return;
        if (!p) { 
          // Empty seat - clickable to sit
          html += '<div class="seat" style="left:'+pos[0]+'%;top:'+pos[1]+'%"><div class="empty-seat clickable-seat" data-seat="'+i+'">Click to Sit</div></div>'; 
          return; 
        }
        const isActive = gs.currentIdx === i && gs.handInProgress;
        const isMe = p.isMe;
        // Show cards if it's me, OR if at showdown and cards have suit (means server sent them)
        const showCards = isMe || (gs.phase === 'showdown' && p.cards && p.cards.length > 0 && p.cards[0].suit);
        html += '<div class="seat" style="left:'+pos[0]+'%;top:'+pos[1]+'%">';
        if (gs.bets[i] > 0) {
          const betChips = Math.min(6, Math.max(1, Math.ceil(gs.bets[i] / gs.bb)));
          html += '<div class="player-bet"><div class="bet-chips">';
          for(let c=0; c<Math.ceil(betChips/2); c++) html += '<div class="bet-chip chip-red"></div>';
          for(let c=0; c<Math.ceil(betChips/3); c++) html += '<div class="bet-chip chip-gold"></div>';
          html += '</div><span>$'+fmt(gs.bets[i])+'</span></div>';
        }
        html += '<div class="player-box '+(isActive?'active':'')+' '+(isMe?'me':'')+' '+(p.folded?'folded':'')+' '+(p.sittingOut?'sitting-out':'')+'">';
        if (i === gs.dealerIdx) html += '<div class="badge badge-dealer">D</div>';
        if (p.allIn) html += '<div class="badge badge-allin">ALL IN</div>';
        if (p.cards && p.cards.length) {
          html += '<div class="player-cards">';
          p.cards.forEach((c, cardIdx) => {
            if (isMe && showCards) {
              // My cards - can double-click to reveal to others
              const isRevealed = state.revealedCards && state.revealedCards[cardIdx];
              html += '<div class="card small '+(c.suit==='h'||c.suit==='d'?'red':'black')+' my-card'+(isRevealed?' revealed':'')+'" data-card-idx="'+cardIdx+'"><span>'+(c.rank==='T'?'10':c.rank)+'</span><span>'+SUIT_SYM[c.suit]+'</span></div>';
            } else {
              html += renderCard(c, true, !showCards);
            }
          });
          html += '</div>';
        } else if (gs.handInProgress && !p.folded && !p.sittingOut) {
          html += '<div class="player-cards">'+renderCard(null,true,true)+renderCard(null,true,true)+'</div>';
        }
        html += '<div class="player-name">'+(isMe?'You':p.name)+(p.sittingOut?' (out)':'')+'</div>';
        html += '<div class="player-chips">$'+fmt(p.chips)+'</div>';
        if (i === gs.sbIdx && gs.handInProgress) html += '<div class="badge badge-sb">SB</div>';
        if (i === gs.bbIdx && gs.handInProgress) html += '<div class="badge badge-bb">BB</div>';
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }
    
    function renderGame() {
      const gs = state.gameState;
      if (!gs) return '<div class="game-container">Loading...</div>';
      const myPlayer = gs.players.find(p=>p&&p.isMe);
      const isMyTurn = myPlayer && gs.currentIdx===myPlayer.seatIdx && !myPlayer.folded && !myPlayer.allIn && gs.phase!=='showdown' && gs.phase!=='waiting' && gs.handInProgress;
      const toCall = myPlayer ? gs.currentBet-(gs.bets[myPlayer.seatIdx]||0) : 0;
      const minRaise = gs.currentBet + (gs.bb||2);
      const maxRaise = myPlayer ? myPlayer.chips+(gs.bets[myPlayer.seatIdx]||0) : 0;
      let html = '<div class="game-container">'+renderGameTable();
      
      // CHAT: Separate messages div from input - input uses stored value
      html += '<div class="chat-box"><div class="chat-header">üí¨ Chat</div><div class="chat-messages" id="chatMessages">'+state.chatMessages.map(m=>'<div class="chat-msg"><span class="name">'+m.name+':</span> '+m.message+'</div>').join('')+'</div><div class="chat-input-container"><input type="text" id="chatInput" placeholder="Type a message..." value="'+chatInputValue.replace(/"/g, '&quot;')+'"></div></div>';
      
      html += '<div class="action-log"><div class="log-header">üìã Action Log</div><div class="log-messages" id="logMessages">'+state.actionLog.map(m=>'<div class="log-msg '+m.type+'">'+m.text+'</div>').join('')+'</div></div>';
      if (state.sittingOut) html += '<button class="sit-in-btn" id="sitInBtn">Sit In Next Hand</button>';
      
      // Show "Show Cards" button at showdown if player can show
      if (gs.phase === 'showdown' && myPlayer && myPlayer.canShow) {
        html += '<button class="sit-in-btn btn-show-cards" id="showCardsBtn">Show Cards</button>';
      }
      
      if (isMyTurn && !state.sittingOut) {
        // Initialize raiseAmt if not set
        if (!state.raiseAmt || state.raiseAmt < minRaise) state.raiseAmt = minRaise;
        html += '<div class="actions">';
        // Raise/bet slider always visible
        html += '<div style="text-align:center;margin-bottom:.4rem"><span style="color:#a1a1aa;font-size:.8rem">'+(gs.currentBet>0?'Raise to':'Bet')+' </span><span class="raise-amount">$'+fmt(state.raiseAmt)+'</span></div>';
        html += '<div class="raise-controls"><button class="raise-btn" id="raiseMinus">‚àí</button><input type="range" class="raise-slider" id="raiseSlider" min="'+minRaise+'" max="'+maxRaise+'" step="'+gs.bb+'" value="'+state.raiseAmt+'"><button class="raise-btn" id="raisePlus">+</button><button class="preset-btn" data-preset="0.5">¬Ω</button><button class="preset-btn" data-preset="0.75">¬æ</button><button class="preset-btn" data-preset="1">Pot</button></div>';
        // Action buttons
        html += '<div class="action-buttons" style="margin-top:.5rem"><button class="action-btn btn-fold" data-action="fold">Fold</button>';
        if (toCall===0) html += '<button class="action-btn btn-check" data-action="check">Check</button>';
        else html += '<button class="action-btn btn-call" data-action="call">Call $'+fmt(Math.min(toCall,myPlayer.chips))+'</button>';
        html += '<button class="action-btn btn-raise" data-action="raise">'+(gs.currentBet>0?'Raise':'Bet')+'</button>';
        html += '</div></div>';
      }
      if (state.winner) html += '<div class="winner-overlay"><div class="winner-box"><div class="winner-title">'+state.winner.names.join(', ')+' Wins!</div>'+(state.winner.cards?'<div class="winner-hand" style="color:#c084fc;font-family:monospace">'+state.winner.cards+'</div>':'')+'<div class="winner-hand">'+state.winner.hand+'</div><div class="winner-amount">+$'+fmt(state.winner.amount)+'</div></div></div>';
      html += '</div>';
      return html;
    }
    
    function attachEvents() {
      document.querySelectorAll('.tab').forEach(tab => { tab.onclick = () => { state.tab = tab.dataset.tab; playSound('click'); render(); }; });
      const refreshBtn = document.getElementById('refreshBtn'); if (refreshBtn) refreshBtn.onclick = () => { socket.emit('getTables'); playSound('click'); };
      
      // Join public table from lobby list
      document.querySelectorAll('.join-btn[data-code]').forEach(btn => { 
        btn.onclick = () => { 
          if (!state.name.trim()) { alert('Enter your name first'); return; } 
          const code = btn.dataset.code; 
          const table = state.tables.find(t=>t.code===code); 
          socket.emit('joinTable', { code, name:state.name, buyIn:table?table.buyIn:state.buyIn, hasCode: true }); 
          localStorage.setItem('pokerName', state.name); 
          playSound('click'); 
        }; 
      });
      
      // Join private table from URL
      const joinPrivateBtn = document.getElementById('joinPrivateBtn'); 
      if (joinPrivateBtn) joinPrivateBtn.onclick = () => { 
        if (!state.name.trim()) { alert('Enter your name'); return; } 
        socket.emit('joinTable', { code: state.tableCode, name: state.name, buyIn: state.buyIn, hasCode: true }); 
        localStorage.setItem('pokerName', state.name); 
        playSound('click'); 
      };
      
      // Back to lobby from private join screen
      const backToLobbyBtn = document.getElementById('backToLobbyBtn');
      if (backToLobbyBtn) backToLobbyBtn.onclick = () => {
        state.hasCodeFromUrl = false;
        state.tableCode = '';
        window.history.replaceState({}, document.title, window.location.pathname);
        render();
      };
      
      const nameInput = document.getElementById('name'); if (nameInput) nameInput.oninput = e => state.name = e.target.value;
      const codeInput = document.getElementById('tableCode'); if (codeInput) codeInput.oninput = e => state.tableCode = e.target.value.toUpperCase();
      const seatsSelect = document.getElementById('maxSeats'); if (seatsSelect) seatsSelect.onchange = e => { state.maxSeats = parseInt(e.target.value); render(); };
      const blindsSelect = document.getElementById('blinds'); if (blindsSelect) blindsSelect.onchange = e => { state.blindsIdx = parseInt(e.target.value); const [sb,bb] = BLINDS[state.blindsIdx]; state.buyIn = bb*100; render(); };
      const buyInSlider = document.getElementById('buyIn'); if (buyInSlider) buyInSlider.oninput = e => { state.buyIn = parseInt(e.target.value); render(); };
      
      // Private toggle
      const privateToggle = document.getElementById('privateToggle');
      if (privateToggle) privateToggle.onclick = () => { state.isPrivate = !state.isPrivate; playSound('click'); render(); };
      
      // Create table
      const createBtn = document.getElementById('createBtn'); 
      if (createBtn) createBtn.onclick = () => { 
        if (!state.name.trim()) { alert('Enter your name'); return; } 
        socket.emit('createTable', { 
          name: state.name, 
          maxSeats: state.maxSeats, 
          blinds: BLINDS[state.blindsIdx], 
          buyIn: state.buyIn,
          isPrivate: state.isPrivate
        }); 
        localStorage.setItem('pokerName', state.name); 
        playSound('click'); 
      };
      
      // Join by code
      const joinBtn = document.getElementById('joinBtn'); 
      if (joinBtn) joinBtn.onclick = () => { 
        if (!state.name.trim()) { alert('Enter your name'); return; } 
        if (!state.tableCode.trim()) { alert('Enter table code'); return; } 
        socket.emit('joinTable', { code: state.tableCode, name: state.name, buyIn: state.buyIn, hasCode: true }); 
        localStorage.setItem('pokerName', state.name); 
        playSound('click'); 
      };
      
      const startBtn = document.getElementById('startBtn'); if (startBtn) startBtn.onclick = () => { socket.emit('startGame'); playSound('click'); };
      const leaveBtn = document.getElementById('leaveBtn'); if (leaveBtn) leaveBtn.onclick = () => { socket.emit('leaveTable'); state.screen='lobby'; state.chatMessages=[]; state.actionLog=[]; state.isPrivate=false; state.lastBoardLength=0; state.isSpectator=false; chatInputValue=''; socket.emit('getTables'); render(); };
      const leaveSeatBtn = document.getElementById('leaveSeatBtn'); if (leaveSeatBtn) leaveSeatBtn.onclick = () => { socket.emit('leaveSeat'); state.isSpectator=true; state.seatIdx=-1; playSound('click'); };
      const lobbyBtn = document.getElementById('lobbyBtn'); if (lobbyBtn) lobbyBtn.onclick = () => { socket.emit('leaveTable'); state.screen='lobby'; state.chatMessages=[]; state.actionLog=[]; state.isPrivate=false; state.lastBoardLength=0; state.isSpectator=false; chatInputValue=''; socket.emit('getTables'); render(); };
      // Clickable seats
      document.querySelectorAll('.clickable-seat').forEach(seat => {
        seat.onclick = () => {
          const seatIdx = parseInt(seat.dataset.seat);
          socket.emit('takeSeat', { seatIdx, buyIn: state.buyIn, name: state.name });
          playSound('click');
        };
      });
      // Double-click to reveal card
      document.querySelectorAll('.my-card').forEach(card => {
        card.ondblclick = () => {
          const cardIdx = parseInt(card.dataset.cardIdx);
          state.revealedCards[cardIdx] = !state.revealedCards[cardIdx];
          socket.emit('revealCard', { cardIdx, revealed: state.revealedCards[cardIdx] });
          playSound('click');
          render();
        };
      });
      
      const sitInBtn = document.getElementById('sitInBtn'); if (sitInBtn) sitInBtn.onclick = () => { socket.emit('sitIn'); state.sittingOut=false; playSound('click'); render(); };
      const showCardsBtn = document.getElementById('showCardsBtn'); if (showCardsBtn) showCardsBtn.onclick = () => { socket.emit('showCards'); playSound('click'); };
      document.querySelectorAll('[data-action]').forEach(btn => { btn.onclick = () => { const action = btn.dataset.action; if (action==='raise') { const gs=state.gameState; socket.emit('action',{action:'raise',amount:state.raiseAmt||(gs.currentBet+gs.bb)}); } else { socket.emit('action',{action}); } playSound(action); }; });
      const raiseSlider = document.getElementById('raiseSlider'); if (raiseSlider) raiseSlider.oninput = e => { state.raiseAmt=parseInt(e.target.value); render(); };
      const raiseMinus = document.getElementById('raiseMinus'); if (raiseMinus) raiseMinus.onclick = () => { const gs=state.gameState; state.raiseAmt=Math.max(gs.currentBet+gs.bb,(state.raiseAmt||gs.currentBet+gs.bb)-gs.bb); playSound('click'); render(); };
      const raisePlus = document.getElementById('raisePlus'); if (raisePlus) raisePlus.onclick = () => { const gs=state.gameState; const myPlayer=gs.players.find(p=>p&&p.isMe); const maxRaise=myPlayer?myPlayer.chips+(gs.bets[myPlayer.seatIdx]||0):0; state.raiseAmt=Math.min(maxRaise,(state.raiseAmt||gs.currentBet+gs.bb)+gs.bb); playSound('click'); render(); };
      document.querySelectorAll('[data-preset]').forEach(btn => { btn.onclick = () => { const gs=state.gameState; const myPlayer=gs.players.find(p=>p&&p.isMe); const maxRaise=myPlayer?myPlayer.chips+(gs.bets[myPlayer.seatIdx]||0):0; const mult=parseFloat(btn.dataset.preset); state.raiseAmt=Math.min(maxRaise,Math.max(gs.currentBet+gs.bb,Math.floor(gs.pot*mult))); playSound('click'); render(); }; });
      
      // CHAT: Track input value independently and restore focus
      const chatInput = document.getElementById('chatInput'); 
      if (chatInput) {
        chatInput.oninput = e => { chatInputValue = e.target.value; };
        chatInput.onfocus = () => { chatInputFocused = true; };
        chatInput.onblur = () => { chatInputFocused = false; };
        chatInput.onkeydown = e => { 
          if (e.key==='Enter' && chatInputValue.trim()) { 
            socket.emit('chat',{message: chatInputValue}); 
            chatInputValue = ''; 
            chatInput.value = '';
          } 
        };
        // Restore focus if it was focused before render
        if (chatInputFocused) {
          chatInput.focus();
          // Put cursor at end
          chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
        }
      }
    }
    
    // Check for new community cards and log them
    function checkBoardCards(gs) {
      if (!gs || !gs.community) return;
      const boardLen = gs.community.length;
      
      if (boardLen > state.lastBoardLength) {
        if (state.lastBoardLength === 0 && boardLen >= 3) {
          // Flop
          state.actionLog.push({
            text: 'üÉè Flop: ' + fmtCards(gs.community.slice(0, 3)),
            type: 'board'
          });
        }
        if (state.lastBoardLength <= 3 && boardLen >= 4) {
          // Turn
          state.actionLog.push({
            text: 'üÉè Turn: ' + fmtCard(gs.community[3]),
            type: 'board'
          });
        }
        if (state.lastBoardLength <= 4 && boardLen >= 5) {
          // River
          state.actionLog.push({
            text: 'üÉè River: ' + fmtCard(gs.community[4]),
            type: 'board'
          });
        }
        state.lastBoardLength = boardLen;
      }
    }
    
    socket.on('tableList', tables => { state.tables=tables; if(state.screen==='lobby')render(); });
    socket.on('tableCreated', ({code,seatIdx,isPrivate}) => { state.tableCode=code; state.seatIdx=seatIdx; state.isHost=true; state.sittingOut=false; if(state.gameState) state.gameState.isPrivate=isPrivate; state.screen = isPrivate ? 'waiting' : 'game'; render(); });
    socket.on('joinedTable', ({code,seatIdx,sittingOut,isPrivate}) => { state.tableCode=code; state.seatIdx=seatIdx; state.sittingOut=sittingOut; state.screen='game'; state.hasCodeFromUrl=false; if(state.gameState) state.gameState.isPrivate=isPrivate; render(); });
    socket.on('tableUpdate', ({seats,gameState,phase,isPrivate,code}) => { state.seats=seats; state.phase=phase; if(gameState){state.gameState=gameState;state.maxSeats=gameState.maxSeats;checkBoardCards(gameState);} if(isPrivate!==undefined && state.gameState) state.gameState.isPrivate=isPrivate; if(code) state.tableCode=code; render(); });
    socket.on('playerJoined', ({name,seatIdx}) => { state.actionLog.push({text:name+' joined',type:'system'}); playSound('click'); render(); });
    socket.on('playerLeft', ({name,seatIdx}) => { state.actionLog.push({text:name+' left',type:'system'}); render(); });
    socket.on('playerSatIn', ({name,seatIdx}) => { state.actionLog.push({text:name+' is now active',type:'system'}); render(); });
    socket.on('seatTaken', ({seatIdx}) => { state.seatIdx=seatIdx; state.isSpectator=false; state.sittingOut=false; render(); });
    socket.on('leftSeat', () => { state.seatIdx=-1; state.isSpectator=true; render(); });
    socket.on('cardRevealed', ({name,seatIdx,cardIdx,card}) => { 
      state.actionLog.push({text: name + ' reveals: ' + card, type:'cards'}); 
      render(); 
    });
    
    // Player showed their cards voluntarily
    socket.on('playerShowedCards', ({name,seatIdx,cards}) => { 
      if (cards) {
        state.actionLog.push({text: name + ' shows: ' + cards, type:'cards'}); 
      } else {
        state.actionLog.push({text: name + ' shows their cards', type:'cards'}); 
      }
      render(); 
    });
    
    socket.on('handStarted', ({handNum}) => { 
      state.screen='game'; 
      state.winner=null; 
      state.lastBoardLength = 0;
      state.revealedCards = [false, false];  // Reset revealed cards for new hand
      state.actionLog.push({text:'‚îÅ‚îÅ‚îÅ Hand #'+handNum+' ‚îÅ‚îÅ‚îÅ',type:'system'}); 
      playSound('deal'); 
      render(); 
    });
    
    socket.on('gameUpdate', gameState => { 
      state.gameState=gameState; 
      state.screen='game'; 
      checkBoardCards(gameState);
      render(); 
    });
    
    socket.on('actionMade', ({seatIdx,name,action,amount}) => { 
      let text='',type=action; 
      if(action==='fold') text=name+' folds'; 
      else if(action==='check') text=name+' checks'; 
      else if(action==='call') text=name+' calls'; 
      else if(action==='raise') text=name+' raises to $'+fmt(amount); 
      else if(action==='allin') text=name+' ALL IN'; 
      state.actionLog.push({text,type}); 
      render(); 
    });
    
    socket.on('sound', ({type}) => { playSound(type); });
    
    socket.on('phaseChange', ({phase,community}) => { 
      // Phase change is now handled by checkBoardCards in gameUpdate
      // This is a backup in case server sends community cards with phaseChange
      if (community && community.length > 0) {
        const gs = state.gameState;
        if (gs) {
          gs.community = community;
          checkBoardCards(gs);
        }
      }
    });
    
    socket.on('handComplete', ({winners,hand,potResults,amount}) => { 
      // Build winner display with cards if available
      const winnerNames = winners.map(w => w.name).join(', ');
      const totalAmount = winners.reduce((sum, w) => sum + w.amount, 0);
      
      // Log the winner with their cards if shown
      let winText = winnerNames + ' wins $' + fmt(totalAmount);
      if (hand && hand !== 'Everyone folded') {
        winText += ' with ' + hand;
      }
      state.actionLog.push({text: winText, type:'win'}); 
      
      // Log showdown cards for all players who went to showdown (if cards were revealed)
      winners.forEach(w => {
        if (w.cards && hand !== 'Everyone folded') {
          state.actionLog.push({text: '  ' + w.name + ': ' + w.cards, type:'cards'});
        }
      });
      
      // Set winner state for overlay
      const winnerCards = (hand !== 'Everyone folded' && winners[0]?.cards) ? winners[0].cards : null;
      state.winner = {
        names: winners.map(w => w.name),
        hand: hand,
        amount: totalAmount,
        cards: winnerCards
      }; 
      
      playSound('win'); 
      render(); 
      setTimeout(()=>{state.winner=null;render();},3500); 
    });
    
    // CHAT: Only update messages, don't touch input
    socket.on('chatMessage', ({name,message}) => { 
      state.chatMessages.push({name,message}); 
      // Only update the messages div, not the whole thing
      const chatEl = document.getElementById('chatMessages'); 
      if (chatEl) {
        chatEl.innerHTML = state.chatMessages.map(m=>'<div class="chat-msg"><span class="name">'+m.name+':</span> '+m.message+'</div>').join('');
        chatEl.scrollTop = chatEl.scrollHeight; 
      }
    });
    
    socket.on('error', ({message}) => { alert(message); });
    socket.on('gameOver', ({winner}) => { alert('Game Over! '+winner+' wins!'); state.screen='lobby'; state.isPrivate=false; state.lastBoardLength=0; chatInputValue=''; socket.emit('getTables'); render(); });
    
    render();
    socket.emit('getTables');
  </script>
</body>
</html>
